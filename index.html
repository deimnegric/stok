<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>BÄ°M Stok Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family:Arial,sans-serif; }
.outer-bg { background:linear-gradient(180deg,#fff0f0 0%,#fff7f7 50%,#fff 100%); min-height:100vh; padding:0 15px 30px; }
.container { max-width:900px; margin:auto; }
.logo-area { text-align:center; padding:15px 0; }
.logo-area img { max-width:140px; }
.card { background:#ffebee; border:2px solid #ef9a9a; border-radius:12px; padding:15px; margin-bottom:20px; }
.card h2 { text-align:center; color:#c62828; }
.form-row { display:flex; flex-wrap:wrap; gap:10px; }
.form-row input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
button { background:#c62828; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }
.stock-item { background:#fff; border:1px solid #ffcdd2; border-radius:10px; padding:12px; margin-bottom:10px; }
.high-stock { background:#ffcdd2; border-color:#e57373; }
.stock-actions { margin-top:8px; }
.stock-actions button { font-size:12px; padding:6px 10px; margin-right:5px; }
.delete { background:#555; }
.high-stock-box { background:#ffcdd2; border:2px dashed #c62828; border-radius:12px; padding:12px; margin-bottom:20px; }
.high-stock-box h3 { margin:0 0 8px; color:#b71c1c; text-align:center; }
.high-stock-box span { display:inline-block; background:#c62828; color:#fff; padding:5px 10px; border-radius:20px; font-size:13px; margin:3px; }
</style>
</head>
<body>
<div class="outer-bg">
<div class="container">

<div class="logo-area">
  <img src="https://upload.wikimedia.org/wikipedia/commons/2/2d/Bim_%28company%29_logo.svg">
</div>

<!-- FAZLA STOK -->
<div id="highStockStores" class="high-stock-box" style="display:none;">
  <h3>ðŸ“¦ Fazla Stok Olan MaÄŸazalar</h3>
  <div id="storeBadges"></div>
</div>

<div class="card">
<h2>Stok GiriÅŸi</h2>
<div class="form-row">
<input id="store" placeholder="MaÄŸaza Ä°smi">
<input id="code" placeholder="ÃœrÃ¼n Kodu">
<input id="name" placeholder="ÃœrÃ¼n Ä°smi">
<input id="qty" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Stok MiktarÄ±">
</div>
<br>
<div style="text-align:center">
<button onclick="saveStock()">Kaydet</button>
</div>
</div>

<div class="card">
<h2>Stoklar</h2>
<div id="stockList"></div>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, doc, deleteDoc, onSnapshot, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCUArkootBSkTyoV09QDklH7nWlZbOJn30",
  authDomain: "bim-stok.firebaseapp.com",
  projectId: "bim-stok",
  storageBucket: "bim-stok.appspot.com",
  messagingSenderId: "736994269858",
  appId: "1:736994269858:web:6abc34a18470f547d5d5fb",
  measurementId: "G-3G8CF3BQ46"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// HTML elements
const storeInput = document.getElementById("store");
const codeInput = document.getElementById("code");
const nameInput = document.getElementById("name");
const qtyInput = document.getElementById("qty");
const stockList = document.getElementById("stockList");
const highBox = document.getElementById("highStockStores");
const badgeArea = document.getElementById("storeBadges");

// KullanÄ±cÄ± ID
let userId = localStorage.getItem("userId") || ("user_" + Math.random().toString(36).substr(2,9));
localStorage.setItem("userId", userId);

// Kaydet fonksiyonu artÄ±k global
window.saveStock = async function() {
  const storeVal = storeInput.value.trim();
  const codeVal = codeInput.value.trim();
  const nameVal = nameInput.value.trim();
  const qtyVal = Number(qtyInput.value);

  if(!storeVal || (!codeVal && !nameVal) || !qtyVal) return alert("Alanlar eksik");

  try {
    const q = query(collection(db,"stocks"), where("store","==",storeVal));
    const snapshot = await getDocs(q);
    let found = false;

    for (const docSnap of snapshot.docs) {
      const s = docSnap.data();
      if((s.code && s.code.toLowerCase()===codeVal.toLowerCase()) || (s.name && s.name.toLowerCase()===nameVal.toLowerCase())){
        await updateDoc(doc(db,"stocks",docSnap.id), { qty: s.qty + qtyVal });
        found = true;
        break;
      }
    }

    if(!found){
      await addDoc(collection(db,"stocks"),{
        store: storeVal, code: codeVal, name: nameVal, qty: qtyVal, userId, created: serverTimestamp()
      });
    }

    [storeInput,codeInput,nameInput,qtyInput].forEach(i=>i.value="");
    storeInput.focus();
    alert("Stok kaydedildi âœ…");
  } catch(err) {
    console.error(err);
    alert("Kaydetme sÄ±rasÄ±nda hata oluÅŸtu!");
  }
};

// Render stoklar
onSnapshot(collection(db,"stocks"), snapshot=>{
  stockList.innerHTML="";
  badgeArea.innerHTML="";
  const highStores = new Set();

  snapshot.forEach(docSnap=>{
    const s = { id: docSnap.id, ...docSnap.data() };

    const d = document.createElement("div");
    d.className = "stock-item";
    if(s.qty > 5){
      d.classList.add("high-stock");
      highStores.add(s.store);
    }

    d.innerHTML = `<b>${s.store}</b><br>${s.name || s.code}<br>Stok: <b>${s.qty}</b>`;

    if(s.userId === userId){
      const actions = document.createElement("div");
      actions.className = "stock-actions";
      actions.innerHTML = `
        <button onclick="editStock('${s.id}')">GÃ¼ncelle</button>
        <button class="delete" onclick="deleteStock('${s.id}')">Sil</button>
      `;
      d.appendChild(actions);
    }

    stockList.appendChild(d);
  });

  if(highStores.size > 0){
    highBox.style.display = "block";
    highStores.forEach(m=>{
      const span = document.createElement("span");
      span.textContent = m;
      badgeArea.appendChild(span);
    });
  } else highBox.style.display = "none";
});

// Edit & delete
window.editStock = async function(id){
  const n = prompt("Yeni stok:");
  if(n!==null) await updateDoc(doc(db,"stocks",id),{ qty:Number(n) });
};

window.deleteStock = async function(id){
  if(!confirm("Silinsin mi?")) return;
  await deleteDoc(doc(db,"stocks",id));
};
</script>
</body>
</html>
