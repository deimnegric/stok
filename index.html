<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Bƒ∞M Stok Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  <script>
// Buraya kendi PIN'ini yazabilirsin
const PIN = "1234"; // ‚Üê deƒüi≈ütirebilirsin

// LocalStorage ile hatƒ±rlatma
if (!localStorage.getItem("pin_ok")) {
  const p = prompt("Yetkili PIN giriniz:");
  if (p === PIN) {
    localStorage.setItem("pin_ok","1");
  } else {
    alert("Yetkisiz giri≈ü!");
    // Siteyi g√∂r√ºnmez yap
    document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>Eri≈üim Engellendi üîí</h2>";
  }
}
</script>
body { margin:0; font-family:Arial,sans-serif; }
.outer-bg { background:linear-gradient(180deg,#fff0f0 0%,#fff7f7 50%,#fff 100%); min-height:100vh; padding:0 15px 30px; }
.container { max-width:900px; margin:auto; }
.logo-area { text-align:center; padding:15px 0; }
.logo-area img { max-width:140px; }

/* √úst uyarƒ± fade in/out */
.top-alert {
  display:none;
  background:#ff5252;
  color:#fff;
  border-radius:12px;
  padding:12px;
  text-align:center;
  font-weight:bold;
  margin-bottom:20px;
  font-size:16px;
  animation: fade 2s infinite alternate;
}
@keyframes fade {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Fazla stok detay kutusu */
.high-stock-box {
  display:none;
  background:#ffcdd2;
  border:2px solid #f44336;
  border-radius:12px;
  padding:12px;
  text-align:center;
  font-weight:bold;
  margin-bottom:20px;
}
.high-stock-box span {
  display:inline-block;
  background:#f44336;
  color:#fff;
  padding:5px 10px;
  border-radius:20px;
  font-size:13px;
  margin:3px;
}

.card { background:#ffebee; border:2px solid #ef9a9a; border-radius:12px; padding:15px; margin-bottom:20px; }
.card h2 { text-align:center; color:#c62828; }
.form-row { display:flex; flex-wrap:wrap; gap:10px; }
.form-row input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
button { background:#c62828; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }
.stock-item { background:#fff; border:1px solid #ffcdd2; border-radius:10px; padding:12px; margin-bottom:10px; transition: background 0.3s; }
.stock-actions { margin-top:8px; }
.stock-actions button { font-size:12px; padding:6px 10px; margin-right:5px; }
.delete { background:#555; }
</style>
</head>
<body>
<div class="outer-bg">
<div class="container">

<div class="logo-area">
  <img src="https://upload.wikimedia.org/wikipedia/commons/2/2d/Bim_%28company%29_logo.svg">
</div>

<!-- √úSTTE FADE IN/OUT UYARI -->
<div id="topAlert" class="top-alert">
üì¶ Fazla Stok Var!
</div>

<!-- STOK Gƒ∞Rƒ∞≈ûƒ∞ -->
<div class="card">
<h2>Stok Giri≈üi</h2>
<div class="form-row">
<input id="store" placeholder="Maƒüaza ƒ∞smi">
<input id="code" placeholder="√úr√ºn Kodu">
<input id="name" placeholder="√úr√ºn ƒ∞smi">
<input id="qty" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Stok Miktarƒ±">
</div>
<br>
<div style="text-align:center">
<button onclick="saveStock()">Kaydet</button>
</div>
</div>

<!-- FAZLA STOK MAƒûAZALARI -->
<div id="highStockStores" class="high-stock-box">
üì¶ Fazla Stok Olan Maƒüazalar: <span id="storeBadges"></span>
</div>

<!-- STOKLAR -->
<div class="card">
<h2>Stoklar</h2>
<div id="stockList"></div>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, doc, deleteDoc, onSnapshot, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCUArkootBSkTyoV09QDklH7nWlZbOJn30",
  authDomain: "bim-stok.firebaseapp.com",
  projectId: "bim-stok",
  storageBucket: "bim-stok.appspot.com",
  messagingSenderId: "736994269858",
  appId: "1:736994269858:web:6abc34a18470f547d5d5fb",
  measurementId: "G-3G8CF3BQ46"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// HTML elemanlarƒ±
const storeInput = document.getElementById("store");
const codeInput = document.getElementById("code");
const nameInput = document.getElementById("name");
const qtyInput = document.getElementById("qty");
const stockList = document.getElementById("stockList");
const highBox = document.getElementById("highStockStores");
const badgeArea = document.getElementById("storeBadges");
const topAlert = document.getElementById("topAlert");

// Kullanƒ±cƒ± ID
let userId = localStorage.getItem("userId") || ("user_" + Math.random().toString(36).substr(2,9));
localStorage.setItem("userId", userId);

// Kaydet fonksiyonu
window.saveStock = async function() {
  const storeVal = storeInput.value.trim();
  const codeVal = codeInput.value.trim();
  const nameVal = nameInput.value.trim();
  const qtyVal = Number(qtyInput.value);

  if(!storeVal || (!codeVal && !nameVal) || !qtyVal) return alert("Alanlar eksik");

  try {
    const q = query(collection(db,"stocks"), where("store","==",storeVal));
    const snapshot = await getDocs(q);
    let found = false;

    for (const docSnap of snapshot.docs) {
      const s = docSnap.data();
      if((s.code && s.code.toLowerCase()===codeVal.toLowerCase()) || (s.name && s.name.toLowerCase()===nameVal.toLowerCase())){
        await updateDoc(doc(db,"stocks",docSnap.id), { qty: s.qty + qtyVal });
        found = true;
        break;
      }
    }

    if(!found){
      await addDoc(collection(db,"stocks"),{
        store: storeVal, code: codeVal, name: nameVal, qty: qtyVal, userId, created: serverTimestamp()
      });
    }

    [storeInput, codeInput, nameInput, qtyInput].forEach(i=>i.value="");
    storeInput.focus();
  } catch(err) {
    console.error(err);
    alert("Kaydetme sƒ±rasƒ±nda hata olu≈ütu!");
  }
};

// Stoklarƒ± render et
onSnapshot(collection(db,"stocks"), snapshot=>{
  stockList.innerHTML = "";
  badgeArea.innerHTML = "";
  const highStores = new Set();

  snapshot.forEach(docSnap=>{
    const s = { id: docSnap.id, ...docSnap.data() };
    const d = document.createElement("div");
    d.className = "stock-item";

    // Dinamik renk: 5'ten fazla ‚Üí giderek koyula≈üan kƒ±rmƒ±zƒ±
    if(s.qty > 5){
      const minQty = 5;
      const maxQty = 20;
      let ratio = (s.qty - minQty) / (maxQty - minQty);
      if(ratio > 1) ratio = 1;

      // rgb(198, gB, gB) ‚Üí stok arttƒ±k√ßa koyula≈üƒ±yor
      const minColor = 198;
      const maxColor = 114;
      const gB = Math.round(minColor - (minColor - maxColor) * ratio);

      d.style.backgroundColor = `rgb(198, ${gB}, ${gB})`;
      d.style.color = "#fff";
      d.style.borderColor = "#b71c1c";

      highStores.add(s.store);
    }

    // √úr√ºn ismi ve kodu birlikte g√∂ster
    let productText = "";
    if(s.name) productText += s.name;
    if(s.name && s.code) productText += " | ";
    if(s.code) productText += s.code;

    d.innerHTML = `<b>${s.store}</b><br>${productText}<br>Stok: <b>${s.qty}</b>`;

    if(s.userId === userId){
      const actions = document.createElement("div");
      actions.className = "stock-actions";
      actions.innerHTML = `
        <button onclick="editStock('${s.id}')">G√ºncelle</button>
        <button class="delete" onclick="deleteStock('${s.id}')">Sil</button>
      `;
      d.appendChild(actions);
    }
    stockList.appendChild(d);
  });

  // √úSTTE GENEL UYARI (fade)
  topAlert.style.display = highStores.size > 0 ? "block" : "none";

  // ORTADA FAZLA STOK DETAY
  if(highStores.size > 0){
    highBox.style.display = "block";
    badgeArea.innerHTML = Array.from(highStores).map(m=>`<span>${m}</span>`).join("");
  } else {
    highBox.style.display = "none";
  }
});

// Edit & delete
window.editStock = async function(id){
  const n = prompt("Yeni stok:");
  if(n!==null) await updateDoc(doc(db,"stocks",id),{ qty:Number(n) });
};

window.deleteStock = async function(id){
  if(!confirm("Silinsin mi?")) return;
  await deleteDoc(doc(db,"stocks",id));
};
</script>
</body>
</html>
